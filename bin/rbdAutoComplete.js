(function($){$.fn.rbdAutoComplete=function(options){var defaults={source:[],remoteSourceStatic:false,onSuggest:null,onSelect:null,queryArg:"term",valueColumn:"",displayColumn:"",suggestionRow:"",queryWait:580,minChars:3,maxSuggestions:15};var plugin=this;var instanceId=$.guid++;console.log("Initializing rbdAutoComplete Plugin: "+instanceId);plugin.cache={};plugin.locked=false;plugin.caller=null;plugin.callerTask=null;plugin.settings={};plugin.currentSelectedIndex=-1;plugin.settings=$.extend({},defaults,options,{instanceId:instanceId,wrapperId:"rb_autocomplete_wrapper"+instanceId,dropdownId:"rb_autocomplete_dropdown"+instanceId});validateSettings(plugin);plugin.wrap('<div id="'+plugin.settings.wrapperId+'" class="rb_autocomplete_wrapper" />');plugin.after('<div id="'+plugin.settings.dropdownId+'" class="rb_autocomplete_dropdown"></div>');plugin.suggestionBox=$("#"+plugin.settings.dropdownId);plugin.keyup(plugin,onKeyPress);plugin.click(plugin,onClick);plugin.select(plugin,onSelected);plugin.blur(plugin,function(event){var plugin=event.data;plugin.chooseSuggestionByIndex(plugin.selectedIndex());plugin.closeSuggestions();});plugin.suggest=function(input){plugin.addClass("processing");if(typeof(plugin.cache[input])=="object"){drawSuggestions(plugin,plugin.cache[input]);}else{if(plugin.settings.mode=="SimpleArray"){plugin.cache[input]=filterSimpleArray(plugin.settings.source,input);drawSuggestions(plugin,plugin.cache[input]);}else{if(plugin.settings.mode=="ComplexArray"){plugin.cache[input]=filterComplexArray(plugin.settings.source,input);drawSuggestions(plugin,plugin.cache[input]);}else{fetchSuggestionsFromURL(plugin,input);}}}};plugin.manuallySelectSuggestion=function(index){var suggestions=plugin.suggestionBox.find("LI");if(typeof(index)!="number"||index>=suggestions.length){return -1;}else{if(plugin.currentSelectedIndex>=0){$(suggestions[plugin.currentSelectedIndex]).removeClass("hover");}}$(suggestions[index]).addClass("hover");return plugin.selectedIndex(Math.max(index,-1));};plugin.chooseSuggestionByIndex=function(index){if(typeof(index)!="number"||index==-1){return -1;}return chooseSuggestionByEl(plugin,$(plugin.suggestionBox.find("LI")[index]));};plugin.selectedIndex=function(index){if(typeof(index)=="number"){plugin.currentSelectedIndex=index;}return plugin.currentSelectedIndex;};plugin.closeSuggestions=function(){plugin.currentSelectedIndex=-1;plugin.suggestionBox.empty();};return plugin;};var chooseSuggestionByEl=function(plugin,el){if(plugin.settings.mode=="SimpleArray"){plugin.val(el.data().selectedValue);}else{plugin.val(el.data().selectedValue[plugin.settings.valueColumn]);}if(typeof(plugin.settings.onSelect)=="function"){plugin.settings.onSelect.call(plugin,el.data().selectedValue);}plugin.closeSuggestions();};var filterSimpleArray=function(aSuggestions,filter){var results=new Array();$.each(aSuggestions,function(index,value){if(value.substr(0,filter.length).toLowerCase()==filter.toLowerCase()){results[results.length]=value;}});return results;};var filterComplexArray=function(aSuggestions,filter){var results=new Array();$.each(aSuggestions,function(index,value){$.each(value,function(i,x){try{if(x.substr(0,filter.length).toLowerCase()==filter){results.push(value);}}catch(e){return;}});});return $.unique(results);};var genDisplayLabel=function(plugin,valueObj){var displayLabel=plugin.settings.suggestionRow;$.each(valueObj,function(index,value){displayLabel=displayLabel.replace(index,value);});return displayLabel;};var onKeyPress=function(event){var plugin=event.data;if(plugin.locked){return -99;}else{if(event.keyCode==27){plugin.closeSuggestions();}else{if(/[ A-Za-z0-9 ]/.test(String.fromCharCode(event.keyCode))||(/(8|46)/).test(event.keyCode)){if(event.currentTarget.value.length>=plugin.settings.minChars){plugin.suggest(event.currentTarget.value);}else{plugin.closeSuggestions();}}else{if(event.keyCode==40){if(plugin.suggestionBox.html().length>0){plugin.manuallySelectSuggestion((plugin.selectedIndex()+1));}else{if(event.currentTarget.value.length>=plugin.settings.minChars){plugin.suggest(event.currentTarget.value);}}}else{if(event.keyCode==38&&plugin.suggestionBox.html().length>0){plugin.manuallySelectSuggestion((plugin.selectedIndex()-1));}else{if(event.keyCode==13&&plugin.selectedIndex()>0){var el=$(plugin.suggestionBox.find("LI")[plugin.selectedIndex()]);chooseSuggestionByEl(plugin,el);}}}}}}return -1;};var onSelected=function(event){var plugin=event.data;if(plugin.locked){return -99;}else{if(event.currentTarget.value.length>=plugin.settings.minChars){plugin.suggest(event.currentTarget.value);}}};var onClick=function(event){var plugin=event.data;if(plugin.locked){return -99;}else{if(plugin.suggestionBox.html().length>0){plugin.closeSuggestions();}else{if(event.currentTarget.value.length>0){plugin.suggest(event.currentTarget.value);}}}};var fetchSuggestionsFromURL=function(plugin,input){if(plugin.callerTask!=null){clearTimeout(plugin.callerTask);}if(plugin.caller!=null&&typeof(plugin.caller.abort)=="function"){plugin.caller.abort();plugin.caller=null;}if(plugin.settings.source.indexOf("?")>0){sourceUrl=plugin.settings.source+"&"+plugin.settings.queryArg+"="+input;}else{sourceUrl=plugin.settings.source+"?"+plugin.settings.queryArg+"="+input;}$(this).attr("id",$.guid++);plugin.callerTask=setTimeout(function(){getJSON(plugin,sourceUrl,input);},plugin.settings.queryWait);};var getJSON=function(plugin,sourceUrl,input){plugin.caller=$.getJSON(sourceUrl,function(json){if(plugin.settings.remoteSourceStatic==true){plugin.locked=true;plugin.settings.source=json;validateSettings(plugin);plugin.suggest(input);plugin.locked=false;}else{plugin.cache[input]=json;drawSuggestions(plugin,json);}});};var drawSuggestions=function(plugin,aSuggestions){if(!$.isArray(aSuggestions)){alert("Return results was not a properly formed array");return -1;}aSuggestions=aSuggestions.slice(0,Math.min(aSuggestions.length,(plugin.settings.maxSuggestions-1)));plugin.suggestionBox.html("<ul></ul>");if(plugin.settings.mode=="SimpleArray"){$.each(aSuggestions,function(index,value){plugin.suggestionBox.find("UL").append("<li><span>"+value+"</span></li>");});}else{if(plugin.settings.displayColumn.length>0){$.each(aSuggestions,function(index,value){plugin.suggestionBox.find("UL").append("<li><span>"+aSuggestions[index][plugin.settings.displayColumn]+"</span></li>");});}else{$.each(aSuggestions,function(index,value){plugin.suggestionBox.find("UL").append("<li><span>"+genDisplayLabel(plugin,aSuggestions[index])+"</span></li>");});}}plugin.suggestionBox.find("LI").each(function(index){$(this).data({selectedValue:aSuggestions[index]});$(this).mouseover({plugin:plugin,index:index},function(event){var i=event.data.index;var plugin=event.data.plugin;plugin.selectedIndex(i);$(event.currentTarget).addClass("hover");});$(this).mouseout(plugin,function(event){var plugin=event.data;plugin.selectedIndex(-1);$(event.currentTarget).removeClass("hover");});$(this).click(plugin,function(event){var plugin=event.data;chooseSuggestionByEl(plugin,$(event.currentTarget));});});plugin.suggestionBox.find("LI").mouseover(plugin,function(event){var plugin=event.data;clearTimeout(plugin.settings.closingTimer);$("#"+plugin.settings.wrapperId).mouseout(plugin,function(event){var plugin=event.data;clearTimeout(plugin.settings.closingTimer);plugin.settings.closingTimer=setTimeout(function(){plugin.closeSuggestions();},250);});});if(typeof(plugin.settings.onSuggest)=="function"){plugin.settings.onSuggest.call(plugin,aSuggestions);}plugin.removeClass("processing");};var validateSettings=function(plugin){var vMultiColumnSetup=function(){if(plugin.settings.valueColumn.length==0){plugin.val("Error");alert("You must provide a valueColumn configuration setting for simple object returns.");return;}else{if(plugin.settings.suggestionRow.length==0&&plugin.settings.displayColumn.length==0){plugin.val("Error");alert("You must provide a suggestionRow configuration setting for simple object returns.");return;}}};if(!plugin.is("INPUT")){alert("You may only initialize rbdAutoComplete on an input tag. "+plugin.is("INPUT"));return -1;}if($.isArray(plugin.settings.source)){if(plugin.settings.source.length==0){alert("The source array for autocomplete "+plugin.selector+" is empty");return -1;}else{if($.isPlainObject(plugin.settings.source[0])){plugin.settings.mode="ComplexArray";vMultiColumnSetup();}else{plugin.settings.mode="SimpleArray";return 1;}}}else{plugin.settings.mode="URL";vMultiColumnSetup();}};}(jQuery));